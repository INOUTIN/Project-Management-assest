<template>
  <div class="gantt-chart">
    <div class="gantt-chart__header">
      <div class="gantt-chart__title-section">
        <el-button 
          :icon="ArrowLeft" 
          @click="goBack"
          class="gantt-chart__back-btn"
        >
          è¿”å›
        </el-button>
        <div class="gantt-chart__title-info">
          <h1 class="gantt-chart__title">{{ project?.name || 'é¡¹ç›®ç”˜ç‰¹å›¾' }}</h1>
          <div class="gantt-chart__subtitle">
            <el-tag :type="getStatusType(project?.status)" size="small">
              {{ getStatusText(project?.status) }}
            </el-tag>
            <span class="gantt-chart__date-range">
              {{ formatDateRange(project?.startDate, project?.endDate) }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="gantt-chart__actions">
        <el-button :icon="Edit" @click="editProject">
          ç¼–è¾‘é¡¹ç›®
        </el-button>
        <el-button type="primary" :icon="Plus" @click="addTask">
          æ·»åŠ ä»»åŠ¡
        </el-button>
      </div>
    </div>

    <!-- é¡¹ç›®æ¦‚è§ˆ -->
    <div class="gantt-chart__overview">
      <div class="overview-cards">
        <div class="overview-card">
          <div class="overview-card__icon">
            <el-icon><List /></el-icon>
          </div>
          <div class="overview-card__content">
            <div class="overview-card__value">{{ project?.tasks?.length || 0 }}</div>
            <div class="overview-card__label">æ€»ä»»åŠ¡æ•°</div>
          </div>
        </div>
        
        <div class="overview-card">
          <div class="overview-card__icon">
            <el-icon><Check /></el-icon>
          </div>
          <div class="overview-card__content">
            <div class="overview-card__value">{{ completedTasksCount }}</div>
            <div class="overview-card__label">å·²å®Œæˆ</div>
          </div>
        </div>
        
        <div class="overview-card">
          <div class="overview-card__icon">
            <el-icon><Clock /></el-icon>
          </div>
          <div class="overview-card__content">
            <div class="overview-card__value">{{ inProgressTasksCount }}</div>
            <div class="overview-card__label">è¿›è¡Œä¸­</div>
          </div>
        </div>
        
        <div class="overview-card">
          <div class="overview-card__icon">
            <el-icon><Warning /></el-icon>
          </div>
          <div class="overview-card__content">
            <div class="overview-card__value">{{ overdueTasksCount }}</div>
            <div class="overview-card__label">è¶…æœŸ</div>
          </div>
        </div>
      </div>
      
      <div class="overview-progress">
        <div class="overview-progress__label">
          é¡¹ç›®è¿›åº¦: {{ projectProgress }}%
        </div>
        <el-progress 
          :percentage="projectProgress" 
          :color="getProgressColor(projectProgress)"
          :stroke-width="8"
        />
      </div>
    </div>

    <!-- ä»»åŠ¡ç®¡ç†åŒºåŸŸ -->
    <div class="gantt-chart__content">
      <div class="gantt-chart__toolbar">
        <div class="gantt-chart__view-controls">
          <el-radio-group v-model="viewMode" size="small">
            <el-radio-button label="table">è¡¨æ ¼è§†å›¾</el-radio-button>
            <el-radio-button label="timeline">æ—¶é—´è½´</el-radio-button>
            <el-radio-button label="calendar">æ—¥å†è§†å›¾</el-radio-button>
          </el-radio-group>
        </div>
        
        <div class="gantt-chart__filters">
          <el-select v-model="statusFilter" placeholder="ç­›é€‰çŠ¶æ€" size="small" clearable>
            <el-option label="å…¨éƒ¨çŠ¶æ€" value="" />
            <el-option label="æœªå¼€å§‹" value="not_started" />
            <el-option label="è¿›è¡Œä¸­" value="in_progress" />
            <el-option label="å·²å®Œæˆ" value="completed" />
            <el-option label="è¶…æœŸ" value="overdue" />
          </el-select>
        </div>
      </div>

      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
      <div class="gantt-chart__main">
        <!-- ä»»åŠ¡è¡¨æ ¼ -->
        <div class="task-table-container" :class="{ 'with-detail-panel': selectedTask }">
          <el-table 
            :data="filteredTasks" 
            style="width: 100%"
            @row-click="handleRowClick"
            :row-class-name="getRowClassName"
            height="600"
          >
            <!-- ä»»åŠ¡åŸºæœ¬ä¿¡æ¯ -->
            <el-table-column prop="name" label="ä»»åŠ¡åç§°" width="180" fixed="left">
              <template #default="scope">
                <div class="task-name-cell">
                  <el-icon v-if="scope.row.isMilestone" class="milestone-icon">
                    <Flag />
                  </el-icon>
                  <span>{{ scope.row.name }}</span>
                </div>
              </template>
            </el-table-column>
            
            <el-table-column prop="assignee" label="è´£ä»»äºº" width="100">
              <template #default="scope">
                <el-tag size="small" type="info">{{ scope.row.assignee || 'æœªåˆ†é…' }}</el-tag>
              </template>
            </el-table-column>

            <!-- è®¡åˆ’æ—¶é—´ -->
            <el-table-column label="è®¡åˆ’å¼€å§‹" width="130">
              <template #header>
                <span class="planned-header">ğŸ“… è®¡åˆ’å¼€å§‹</span>
              </template>
              <template #default="scope">
                <div class="time-cell planned">
                  {{ formatDate(scope.row.startDate) }}
                </div>
              </template>
            </el-table-column>

            <el-table-column label="è®¡åˆ’ç»“æŸ" width="130">
              <template #header>
                <span class="planned-header">ğŸ“… è®¡åˆ’ç»“æŸ</span>
              </template>
              <template #default="scope">
                <div class="time-cell planned">
                  {{ formatDate(scope.row.endDate) }}
                </div>
              </template>
            </el-table-column>

            <!-- å®é™…æ—¶é—´ (å¯ç¼–è¾‘) -->
            <el-table-column label="å®é™…å¼€å§‹" width="130">
              <template #header>
                <span class="actual-header">âœ… å®é™…å¼€å§‹</span>
              </template>
              <template #default="scope">
                <div 
                  class="time-cell actual editable"
                  :class="{ 'has-value': scope.row.actualStartDate }"
                  @dblclick="editActualStartDate(scope.row)"
                >
                  <span v-if="scope.row.actualStartDate">
                    {{ formatDate(scope.row.actualStartDate) }}
                  </span>
                  <span v-else class="placeholder">åŒå‡»è®¾ç½®</span>
                  <el-icon class="edit-icon"><Edit /></el-icon>
                </div>
              </template>
            </el-table-column>

            <el-table-column label="å®é™…ç»“æŸ" width="130">
              <template #header>
                <span class="actual-header">âœ… å®é™…ç»“æŸ</span>
              </template>
              <template #default="scope">
                <div 
                  class="time-cell actual editable"
                  :class="{ 
                    'has-value': scope.row.actualEndDate,
                    'overdue': isOverdue(scope.row)
                  }"
                  @dblclick="editActualEndDate(scope.row)"
                >
                  <span v-if="scope.row.actualEndDate">
                    {{ formatDate(scope.row.actualEndDate) }}
                  </span>
                  <span v-else class="placeholder">åŒå‡»è®¾ç½®</span>
                  <el-icon class="edit-icon"><Edit /></el-icon>
                </div>
              </template>
            </el-table-column>

            <!-- è¿›åº¦å’ŒçŠ¶æ€ -->
            <el-table-column label="è¿›åº¦" width="120">
              <template #default="scope">
                <div class="progress-cell">
                  <el-progress 
                    :percentage="scope.row.progress || 0" 
                    :stroke-width="6"
                    :color="getProgressColor(scope.row)"
                    :show-text="false"
                  />
                  <span class="progress-text">{{ scope.row.progress || 0 }}%</span>
                </div>
              </template>
            </el-table-column>

            <el-table-column prop="status" label="çŠ¶æ€" width="100">
              <template #default="scope">
                <el-tag 
                  :type="getTaskStatusType(scope.row.status)" 
                  size="small"
                  :class="{ 'status-overdue': isOverdue(scope.row) }"
                >
                  {{ getTaskStatusText(scope.row.status) }}
                </el-tag>
              </template>
            </el-table-column>

            <!-- å¤‡æ³¨åˆ— -->
            <el-table-column label="å¤‡æ³¨" width="150">
              <template #default="scope">
                <div class="notes-cell">
                  <span v-if="scope.row.notes && scope.row.notes.trim()" 
                        class="notes-content" 
                        :title="scope.row.notes">
                    {{ scope.row.notes.length > 20 ? scope.row.notes.substring(0, 20) + '...' : scope.row.notes }}
                  </span>
                  <span v-else class="notes-placeholder">æš‚æ— å¤‡æ³¨</span>
                </div>
              </template>
            </el-table-column>

            <!-- æ“ä½œåˆ— -->
            <el-table-column label="æ“ä½œ" width="120" fixed="right">
              <template #default="scope">
                <div class="action-buttons">
                  <el-button 
                    :icon="View" 
                    size="small" 
                    text 
                    @click.stop="showTaskDetail(scope.row)"
                    title="æŸ¥çœ‹è¯¦æƒ…"
                  />
                  <el-button 
                    :icon="Edit" 
                    size="small" 
                    text 
                    @click.stop="editTask(scope.row)"
                    title="ç¼–è¾‘ä»»åŠ¡"
                  />
                  <el-button 
                    :icon="Delete" 
                    size="small" 
                    text 
                    type="danger"
                    @click.stop="deleteTask(scope.row)"
                    title="åˆ é™¤ä»»åŠ¡"
                  />
                </div>
              </template>
            </el-table-column>
          </el-table>
          
          <div v-if="filteredTasks.length === 0" class="empty-state">
            <el-empty description="æš‚æ— ä»»åŠ¡æ•°æ®">
              <el-button type="primary" @click="addTask">æ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡</el-button>
            </el-empty>
          </div>
        </div>

        <!-- ä»»åŠ¡è¯¦æƒ…é¢æ¿ -->
        <div v-if="selectedTask" class="task-detail-panel">
          <div class="detail-panel-header">
            <h3>ä»»åŠ¡è¯¦æƒ…</h3>
            <el-button :icon="Close" size="small" text @click="closeDetailPanel" />
          </div>
          
          <div class="detail-panel-content">
            <!-- åŸºæœ¬ä¿¡æ¯åŒºåŸŸ -->
            <div class="detail-section">
              <h4>åŸºæœ¬ä¿¡æ¯</h4>
              <div class="detail-form">
                <el-form :model="selectedTask" label-width="80px" size="small">
                  <el-form-item label="ä»»åŠ¡åç§°">
                    <el-input v-model="selectedTask.name" @blur="updateTask" />
                  </el-form-item>
                  <el-form-item label="æè¿°">
                    <el-input 
                      v-model="selectedTask.description" 
                      type="textarea" 
                      :rows="2"
                      @blur="updateTask"
                    />
                  </el-form-item>
                  <el-form-item label="è´£ä»»äºº">
                    <el-input v-model="selectedTask.assignee" @blur="updateTask" />
                  </el-form-item>
                </el-form>
              </div>
            </div>

            <!-- å¿«æ·æ“ä½œåŒºåŸŸ -->
            <div class="detail-section">
              <h4>å¿«æ·æ“ä½œ</h4>
              <div class="quick-actions">
                <el-button 
                  size="small" 
                  @click="setActualStartToday"
                  :disabled="!!selectedTask.actualStartDate"
                >
                  ä»Šå¤©å¼€å§‹
                </el-button>
                <el-button 
                  size="small" 
                  @click="setActualEndToday"
                  :disabled="!!selectedTask.actualEndDate"
                >
                  ä»Šå¤©å®Œæˆ
                </el-button>
                <el-button 
                  size="small" 
                  type="warning"
                  @click="resetActualTimes"
                >
                  é‡ç½®å®é™…æ—¶é—´
                </el-button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘é¡¹ç›®å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showEditDialog"
      title="ç¼–è¾‘é¡¹ç›®"
      width="900px"
      :before-close="handleCloseEditDialog"
    >
      <div class="project-edit-dialog">
        <!-- é¡¹ç›®åŸºæœ¬ä¿¡æ¯ -->
        <div class="edit-section">
          <h3 class="section-title">
            <el-icon><Edit /></el-icon>
            é¡¹ç›®åŸºæœ¬ä¿¡æ¯
          </h3>
          <el-form :model="editingProject" label-width="100px" size="default">
            <el-row :gutter="20">
              <el-col :span="12">
                <el-form-item label="é¡¹ç›®åç§°">
                  <el-input v-model="editingProject.name" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" />
                </el-form-item>
              </el-col>
              <el-col :span="12">
                <el-form-item label="é¡¹ç›®çŠ¶æ€">
                  <el-tag :type="getStatusType(project?.status)" size="default">
                    {{ getStatusText(project?.status) }}
                  </el-tag>
                  <span class="status-note">ï¼ˆçŠ¶æ€ç”±ä»»åŠ¡è‡ªåŠ¨è®¡ç®—ï¼‰</span>
                </el-form-item>
              </el-col>
            </el-row>
            <el-form-item label="é¡¹ç›®æè¿°">
              <el-input 
                v-model="editingProject.description" 
                type="textarea" 
                :rows="3"
                placeholder="è¯·è¾“å…¥é¡¹ç›®æè¿°"
              />
            </el-form-item>
            <el-row :gutter="20">
              <el-col :span="12">
                <el-form-item label="è®¡åˆ’å¼€å§‹">
                  <el-date-picker
                    v-model="editingProject.startDate"
                    type="date"
                    placeholder="é€‰æ‹©å¼€å§‹æ—¥æœŸ"
                    style="width: 100%"
                  />
                </el-form-item>
              </el-col>
              <el-col :span="12">
                <el-form-item label="è®¡åˆ’ç»“æŸ">
                  <el-date-picker
                    v-model="editingProject.endDate"
                    type="date"
                    placeholder="é€‰æ‹©ç»“æŸæ—¥æœŸ"
                    style="width: 100%"
                  />
                </el-form-item>
              </el-col>
            </el-row>
          </el-form>
        </div>

        <!-- ä»»åŠ¡æ‰§è¡Œæƒ…å†µ -->
        <div class="edit-section">
          <h3 class="section-title">
            <el-icon><Clock /></el-icon>
            ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
          </h3>
          
          <div v-if="editingProject.tasks && editingProject.tasks.length > 0" class="tasks-edit-area">
            <div 
              v-for="(task, index) in editingProject.tasks" 
              :key="task.id || index"
              class="task-edit-item"
            >
              <div class="task-header">
                <div class="task-info">
                  <span class="task-name">{{ task.name }}</span>
                  <el-tag :type="getTaskStatusType(task.status)" size="small">
                    {{ getTaskStatusText(task.status) }}
                  </el-tag>
                  <span v-if="task.isMilestone" class="milestone-badge">
                    <el-icon><Flag /></el-icon>
                    é‡Œç¨‹ç¢‘
                  </span>
                </div>
                <div class="task-assignee">
                  <span v-if="task.assignee">è´Ÿè´£äºº: {{ task.assignee }}</span>
                </div>
              </div>
              
              <div class="task-times">
                <el-row :gutter="16">
                  <el-col :span="6">
                    <div class="time-item">
                      <label>è®¡åˆ’å¼€å§‹:</label>
                      <div class="time-value planned">
                        {{ DateUtils.format(task.startDate, 'YYYY-MM-DD') }}
                      </div>
                    </div>
                  </el-col>
                  <el-col :span="6">
                    <div class="time-item">
                      <label>è®¡åˆ’ç»“æŸ:</label>
                      <div class="time-value planned">
                        {{ DateUtils.format(task.endDate, 'YYYY-MM-DD') }}
                      </div>
                    </div>
                  </el-col>
                  <el-col :span="6">
                    <div class="time-item">
                      <label>å®é™…å¼€å§‹:</label>
                      <el-date-picker
                        v-model="task.actualStartDate"
                        type="datetime"
                        placeholder="é€‰æ‹©å®é™…å¼€å§‹æ—¶é—´"
                        size="small"
                        style="width: 100%"
                        @change="handleActualTimeChange(task, 'start')"
                      />
                      <div class="quick-actions">
                        <el-button 
                          size="small" 
                          text 
                          type="primary"
                          @click="setTaskActualStartToday(task)"
                        >
                          ä»Šå¤©å¼€å§‹
                        </el-button>
                      </div>
                    </div>
                  </el-col>
                  <el-col :span="6">
                    <div class="time-item">
                      <label>å®é™…ç»“æŸ:</label>
                      <el-date-picker
                        v-model="task.actualEndDate"
                        type="datetime"
                        placeholder="é€‰æ‹©å®é™…ç»“æŸæ—¶é—´"
                        size="small"
                        style="width: 100%"
                        :disabled="!task.actualStartDate"
                        @change="handleActualTimeChange(task, 'end')"
                      />
                      <div class="quick-actions">
                        <el-button 
                          size="small" 
                          text 
                          type="success"
                          :disabled="!task.actualStartDate"
                          @click="setTaskActualEndToday(task)"
                        >
                          ä»Šå¤©å®Œæˆ
                        </el-button>
                      </div>
                    </div>
                  </el-col>
                </el-row>
              </div>
              
              <div class="task-notes">
                <el-form-item label="å¤‡æ³¨:">
                  <el-input
                    v-model="task.notes"
                    type="textarea"
                    :rows="2"
                    placeholder="è®°å½•ä»»åŠ¡æ‰§è¡Œæƒ…å†µã€é‡åˆ°çš„é—®é¢˜ã€è§£å†³æ–¹æ¡ˆç­‰..."
                    @blur="handleNotesChange(task)"
                  />
                  <div class="notes-templates">
                    <span class="template-label">å¸¸ç”¨å¤‡æ³¨:</span>
                    <el-button 
                      size="small" 
                      text 
                      @click="setNoteTemplate(task, 'æŒ‰æ—¶å®Œæˆï¼Œæ— é—®é¢˜')"
                    >
                      æŒ‰æ—¶å®Œæˆ
                    </el-button>
                    <el-button 
                      size="small" 
                      text 
                      @click="setNoteTemplate(task, 'æå‰å®Œæˆ')"
                    >
                      æå‰å®Œæˆ
                    </el-button>
                    <el-button 
                      size="small" 
                      text 
                      @click="setNoteTemplate(task, 'é‡åˆ°æŠ€æœ¯éš¾é¢˜ï¼Œéœ€è¦æ”¯æŒ')"
                    >
                      é‡åˆ°é—®é¢˜
                    </el-button>
                    <el-button 
                      size="small" 
                      text 
                      @click="setNoteTemplate(task, 'ç­‰å¾…å…¶ä»–ä»»åŠ¡å®Œæˆ')"
                    >
                      ç­‰å¾…ä¾èµ–
                    </el-button>
                  </div>
                </el-form-item>
              </div>
            </div>
          </div>
          
          <div v-else class="no-tasks">
            <el-empty description="æš‚æ— ä»»åŠ¡" size="small">
              <el-button type="primary" @click="addTask">æ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡</el-button>
            </el-empty>
          </div>
        </div>
      </div>
      
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="cancelEditProject">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="saveProject" :loading="saving">
            ä¿å­˜é¡¹ç›®
          </el-button>
        </div>
      </template>
    </el-dialog>

    <!-- æ·»åŠ /ç¼–è¾‘ä»»åŠ¡å¯¹è¯æ¡† -->
    <el-dialog
      v-model="showTaskDialog"
      :title="editingTask ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ·»åŠ ä»»åŠ¡'"
      width="700px"
      :before-close="handleCloseTaskDialog"
    >
      <div class="task-edit-dialog">
        <el-form :model="editingTaskForm" label-width="100px" size="default">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="ä»»åŠ¡åç§°" required>
                <el-input v-model="editingTaskForm.name" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="è´£ä»»äºº">
                <el-input v-model="editingTaskForm.assignee" placeholder="è¯·è¾“å…¥è´£ä»»äºº" />
              </el-form-item>
            </el-col>
          </el-row>
          
          <el-form-item label="ä»»åŠ¡æè¿°">
            <el-input 
              v-model="editingTaskForm.description" 
              type="textarea" 
              :rows="3"
              placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°"
            />
          </el-form-item>

          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="è®¡åˆ’å¼€å§‹">
                <el-date-picker
                  v-model="editingTaskForm.startDate"
                  type="date"
                  placeholder="é€‰æ‹©å¼€å§‹æ—¥æœŸ"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="è®¡åˆ’ç»“æŸ">
                <el-date-picker
                  v-model="editingTaskForm.endDate"
                  type="date"
                  placeholder="é€‰æ‹©ç»“æŸæ—¥æœŸ"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
          </el-row>

          <el-row :gutter="20">
            <el-col :span="12">
              <el-form-item label="å®é™…å¼€å§‹">
                <el-date-picker
                  v-model="editingTaskForm.actualStartDate"
                  type="datetime"
                  placeholder="é€‰æ‹©å®é™…å¼€å§‹æ—¶é—´"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="å®é™…ç»“æŸ">
                <el-date-picker
                  v-model="editingTaskForm.actualEndDate"
                  type="datetime"
                  placeholder="é€‰æ‹©å®é™…ç»“æŸæ—¶é—´"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
          </el-row>

          <el-form-item label="é‡Œç¨‹ç¢‘">
            <el-switch v-model="editingTaskForm.isMilestone" />
          </el-form-item>

          <el-form-item label="å¤‡æ³¨">
            <el-input 
              v-model="editingTaskForm.notes" 
              type="textarea" 
              :rows="3"
              placeholder="è¯·è¾“å…¥ä»»åŠ¡å¤‡æ³¨"
            />
            <div class="notes-templates" style="margin-top: 8px;">
              <span class="template-label">å¸¸ç”¨å¤‡æ³¨:</span>
              <el-button size="small" text @click="setTaskNoteTemplate('è¿›å±•é¡ºåˆ©')">è¿›å±•é¡ºåˆ©</el-button>
              <el-button size="small" text @click="setTaskNoteTemplate('é‡åˆ°å›°éš¾')">é‡åˆ°å›°éš¾</el-button>
              <el-button size="small" text @click="setTaskNoteTemplate('éœ€è¦æ”¯æŒ')">éœ€è¦æ”¯æŒ</el-button>
              <el-button size="small" text @click="setTaskNoteTemplate('å·²å®Œæˆ')">å·²å®Œæˆ</el-button>
            </div>
          </el-form-item>

          <!-- å¿«æ·æ“ä½œ -->
          <el-form-item label="å¿«æ·æ“ä½œ">
            <div class="quick-actions">
              <el-button 
                size="small" 
                @click="setTaskActualStartToday"
                :disabled="!!editingTaskForm.actualStartDate"
              >
                ä»Šå¤©å¼€å§‹
              </el-button>
              <el-button 
                size="small" 
                @click="setTaskActualEndToday"
                :disabled="!!editingTaskForm.actualEndDate"
              >
                ä»Šå¤©å®Œæˆ
              </el-button>
              <el-button 
                size="small" 
                type="warning"
                @click="resetTaskActualTimes"
              >
                é‡ç½®å®é™…æ—¶é—´
              </el-button>
            </div>
          </el-form-item>
        </el-form>
      </div>
      
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="handleCloseTaskDialog">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="saveTask">ä¿å­˜</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { 
  ArrowLeft, Edit, Plus, List, Check, Clock, Warning, 
  Delete, View, Close, Flag, ArrowRight
} from '@element-plus/icons-vue'

// æ•°æ®æœåŠ¡
import { projectDataService } from '@shared/services/data/ProjectDataService.js'
import { DateUtils } from '@shared/utils/date.js'

const route = useRoute()
const router = useRouter()

// ä½¿ç”¨å•ä¾‹æ•°æ®æœåŠ¡

// å“åº”å¼æ•°æ®
const loading = ref(false)
const project = ref(null)
const projectId = computed(() => route.params.id)
const viewMode = ref('table')
const statusFilter = ref('')
const showEditDialog = ref(false)
const showTaskDialog = ref(false)

const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
=======
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======

// è®¡ç®—å±æ€§
=======
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======

// è®¡ç®—å±æ€§
=======
const editingTask = ref(null)
const selectedTask = ref(null)
const editingProject = ref({})
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======
const editingTaskForm = ref({})
const saving = ref(false)

// è®¡ç®—å±æ€§
=======

// è®¡ç®—å±æ€§
const completedTasksCount = computed(() => {
  return project.value?.tasks?.filter(task => task.status === 'completed').length || 0
})

const inProgressTasksCount = computed(() => {
  return project.value?.tasks?.filter(task => task.status === 'in_progress').length || 0
})

const overdueTasksCount = computed(() => {
  return project.value?.tasks?.filter(task => task.status === 'overdue').length || 0
})

const projectProgress = computed(() => {
  const tasks = project.value?.tasks || []
  if (tasks.length === 0) return 0
  
  const completedTasks = tasks.filter(task => task.status === 'completed').length
  return Math.round((completedTasks / tasks.length) * 100)
})

const filteredTasks = computed(() => {
  let tasks = project.value?.tasks || []
  
  if (statusFilter.value) {
    tasks = tasks.filter(task => task.status === statusFilter.value)
  }
  
  // æŒ‰å¼€å§‹æ—¶é—´æ’åº
  return tasks.sort((a, b) => new Date(a.startDate) - new Date(b.startDate))
})

// æ–¹æ³•
const loadProject = async () => {
  if (!projectId.value) return
  
  loading.value = true
  try {
    project.value = await projectDataService.findById(projectId.value)
    if (!project.value) {
      ElMessage.error('é¡¹ç›®ä¸å­˜åœ¨')
      router.push('/project-management')
    }
  } catch (error) {
    console.error('Failed to load project:', error)
    ElMessage.error('åŠ è½½é¡¹ç›®å¤±è´¥')
  } finally {
    loading.value = false
  }
}

const goBack = () => {
  router.go(-1)
}

const editProject = () => {
  // æ·±æ‹·è´é¡¹ç›®æ•°æ®ç”¨äºç¼–è¾‘
  editingProject.value = JSON.parse(JSON.stringify(project.value))
  
  // ç¡®ä¿ä»»åŠ¡æœ‰noteså­—æ®µ
  if (editingProject.value.tasks) {
    editingProject.value.tasks.forEach(task => {
      if (!task.notes) {
        task.notes = ''
      }
    })
  }
  
  showEditDialog.value = true
}

const addTask = () => {
  editingTask.value = null
  // åˆå§‹åŒ–æ–°ä»»åŠ¡è¡¨å•æ•°æ®
  editingTaskForm.value = {
    id: '',
    name: '',
    description: '',
    assignee: '',
    startDate: null,
    endDate: null,
    actualStartDate: null,
    actualEndDate: null,
    isMilestone: false,
    notes: '',
    status: 'not_started',
    progress: 0
  }
  showTaskDialog.value = true
}

const editTask = (task) => {
  editingTask.value = { ...task }
  // åˆå§‹åŒ–ç¼–è¾‘è¡¨å•æ•°æ®
  editingTaskForm.value = {
    id: task.id,
    name: task.name || '',
    description: task.description || '',
    assignee: task.assignee || '',
    startDate: task.startDate ? new Date(task.startDate) : null,
    endDate: task.endDate ? new Date(task.endDate) : null,
    actualStartDate: task.actualStartDate ? new Date(task.actualStartDate) : null,
    actualEndDate: task.actualEndDate ? new Date(task.actualEndDate) : null,
    isMilestone: task.isMilestone || false,
    notes: task.notes || '',
    status: task.status || 'not_started',
    progress: task.progress || 0
  }
  showTaskDialog.value = true
}

const deleteTask = async (task) => {
  try {
    await ElMessageBox.confirm(
      `ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${task.name}"å—ï¼Ÿ`,
      'ç¡®è®¤åˆ é™¤',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning',
      }
    )

    // ä»é¡¹ç›®ä¸­ç§»é™¤ä»»åŠ¡
    const taskIndex = project.value.tasks.findIndex(t => t.id === task.id)
    if (taskIndex > -1) {
      project.value.tasks.splice(taskIndex, 1)
      
      // æ›´æ–°é¡¹ç›®
      await projectDataService.update(projectId.value, project.value)
      ElMessage.success('ä»»åŠ¡åˆ é™¤æˆåŠŸ')
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('Failed to delete task:', error)
      ElMessage.error('åˆ é™¤ä»»åŠ¡å¤±è´¥')
    }
  }
}

// å•ä»»åŠ¡ç¼–è¾‘ç›¸å…³æ–¹æ³•
const handleCloseTaskDialog = () => {
  editingTaskForm.value = {}
  showTaskDialog.value = false
}

const saveTask = async () => {
  try {
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!editingTaskForm.value.name || !editingTaskForm.value.name.trim()) {
      ElMessage.error('è¯·è¾“å…¥ä»»åŠ¡åç§°')
      return
    }

    // æ›´æ–°ä»»åŠ¡çŠ¶æ€åŸºäºå®é™…æ—¶é—´
    updateTaskStatusBasedOnActualTimes()

    if (editingTask.value) {
      // ç¼–è¾‘ç°æœ‰ä»»åŠ¡
      const taskIndex = project.value.tasks.findIndex(t => t.id === editingTask.value.id)
      if (taskIndex > -1) {
        // æ›´æ–°ä»»åŠ¡æ•°æ®
        project.value.tasks[taskIndex] = {
          ...project.value.tasks[taskIndex],
          ...editingTaskForm.value,
          updatedAt: new Date().toISOString()
        }
      }
    } else {
      // æ·»åŠ æ–°ä»»åŠ¡
      const newTask = {
        id: Date.now().toString(),
        ...editingTaskForm.value,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      }
      
      if (!project.value.tasks) {
        project.value.tasks = []
      }
      project.value.tasks.push(newTask)
    }

    // ä¿å­˜é¡¹ç›®
    await projectDataService.update(projectId.value, project.value)
    
    ElMessage.success(editingTask.value ? 'ä»»åŠ¡æ›´æ–°æˆåŠŸ' : 'ä»»åŠ¡æ·»åŠ æˆåŠŸ')
    handleCloseTaskDialog()
    
  } catch (error) {
    console.error('Failed to save task:', error)
    ElMessage.error('ä¿å­˜ä»»åŠ¡å¤±è´¥')
  }
}

const updateTaskStatusBasedOnActualTimes = () => {
  const form = editingTaskForm.value
  const now = new Date()
  
  if (form.actualEndDate) {
    form.status = 'completed'
    form.progress = 100
  } else if (form.actualStartDate) {
    form.status = 'in_progress'
    if (!form.progress || form.progress === 0) {
      form.progress = 50 // é»˜è®¤è¿›åº¦
    }
  } else {
    form.status = 'not_started'
    form.progress = 0
  }
  
  // æ£€æŸ¥æ˜¯å¦è¶…æœŸ
  if (form.endDate && new Date(form.endDate) < now && form.status !== 'completed') {
    if (form.status === 'not_started') {
      form.status = 'overdue'
    } else if (form.status === 'in_progress') {
      form.status = 'overdue'
    }
  }
}

const setTaskNoteTemplate = (template) => {
  if (editingTaskForm.value.notes && editingTaskForm.value.notes.trim()) {
    ElMessageBox.confirm(
      'å½“å‰ä»»åŠ¡å·²æœ‰å¤‡æ³¨ï¼Œæ˜¯å¦è¦æ›¿æ¢ä¸ºæ¨¡æ¿å†…å®¹ï¼Ÿ',
      'ç¡®è®¤æ›¿æ¢',
      {
        confirmButtonText: 'æ›¿æ¢',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    ).then(() => {
      editingTaskForm.value.notes = template
    }).catch(() => {
      // ç”¨æˆ·å–æ¶ˆï¼Œä¸åšä»»ä½•æ“ä½œ
    })
  } else {
    editingTaskForm.value.notes = template
  }
}

const setTaskActualStartToday = () => {
  editingTaskForm.value.actualStartDate = new Date()
  updateTaskStatusBasedOnActualTimes()
}

const setTaskActualEndToday = () => {
  editingTaskForm.value.actualEndDate = new Date()
  updateTaskStatusBasedOnActualTimes()
}

const resetTaskActualTimes = () => {
  editingTaskForm.value.actualStartDate = null
  editingTaskForm.value.actualEndDate = null
  updateTaskStatusBasedOnActualTimes()
}

// å·¥å…·æ–¹æ³•
const getStatusType = (status) => {
  const statusMap = {
    'not_started': '',
    'in_progress': 'warning',
    'completed': 'success',
    'overdue': 'danger',
    // å¤åˆçŠ¶æ€ç±»å‹ï¼ˆä¸»è¦çŠ¶æ€å†³å®šé¢œè‰²ï¼‰
    'overdue_not_started': 'danger',
    'overdue_in_progress': 'warning',
    'completed_overdue': 'success'
  }
  return statusMap[status] || ''
}

const getStatusText = (status) => {
  const statusMap = {
    'not_started': 'æœªå¼€å§‹',
    'in_progress': 'è¿›è¡Œä¸­',
    'completed': 'å·²å®Œæˆ',
    'overdue': 'è¶…æœŸ',
    // å¤åˆçŠ¶æ€æ–‡æœ¬
    'overdue_not_started': 'è¶…æœŸ+æœªå¼€å§‹',
    'overdue_in_progress': 'è¶…æœŸ+è¿›è¡Œä¸­',
    'completed_overdue': 'å·²å®Œæˆ+è¶…æœŸ'
  }
  return statusMap[status] || 'æœªçŸ¥'
}

const getTaskStatusType = (status) => {
  return getStatusType(status)
}

const getTaskStatusText = (status) => {
  return getStatusText(status)
}

const formatDateRange = (startDate, endDate) => {
  if (!startDate || !endDate) return ''
  return `${DateUtils.format(startDate, 'YYYY-MM-DD')} ~ ${DateUtils.format(endDate, 'YYYY-MM-DD')}`
}

const getProgressColor = (task) => {
  const percentage = task.progress || 0
  if (isOverdue(task)) return '#f56c6c'
  if (percentage < 30) return '#909399'
  if (percentage < 70) return '#e6a23c'
  return '#67c23a'
}

// è¡¨æ ¼å†…è”ç¼–è¾‘å’Œè¯¦æƒ…é¢æ¿
const handleRowClick = (row) => {
  selectedTask.value = { ...row }
}

const showTaskDetail = (task) => {
  selectedTask.value = { ...task }
}

const closeDetailPanel = () => {
  selectedTask.value = null
}

const getRowClassName = ({ row }) => {
  let className = ''
  if (selectedTask.value && selectedTask.value.id === row.id) {
    className += 'selected-row '
  }
  if (isOverdue(row)) {
    className += 'overdue-row '
  }
  if (row.isMilestone) {
    className += 'milestone-row '
  }
  return className.trim()
}

// æ—¶é—´ç¼–è¾‘æ–¹æ³•
const editActualStartDate = async (task) => {
  try {
    const { value: date } = await ElMessageBox.prompt(
      'è¯·é€‰æ‹©å®é™…å¼€å§‹æ—¶é—´',
      'ç¼–è¾‘å®é™…å¼€å§‹æ—¶é—´',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        inputType: 'date',
        inputValue: task.actualStartDate || DateUtils.format(new Date(), 'YYYY-MM-DD')
      }
    )
    
    if (date) {
      task.actualStartDate = date
      // å¦‚æœè®¾ç½®äº†å®é™…å¼€å§‹æ—¶é—´ï¼Œè‡ªåŠ¨å°†çŠ¶æ€æ”¹ä¸ºè¿›è¡Œä¸­
      if (task.status === 'not_started') {
        task.status = 'in_progress'
      }
      await updateTaskInProject(task)
      ElMessage.success('å®é™…å¼€å§‹æ—¶é—´å·²æ›´æ–°')
    }
  } catch (error) {
    // ç”¨æˆ·å–æ¶ˆæ“ä½œ
  }
}

const editActualEndDate = async (task) => {
  try {
    const { value: date } = await ElMessageBox.prompt(
      'è¯·é€‰æ‹©å®é™…ç»“æŸæ—¶é—´',
      'ç¼–è¾‘å®é™…ç»“æŸæ—¶é—´',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        inputType: 'date',
        inputValue: task.actualEndDate || DateUtils.format(new Date(), 'YYYY-MM-DD')
      }
    )
    
    if (date) {
      task.actualEndDate = date
      // å¦‚æœè®¾ç½®äº†å®é™…ç»“æŸæ—¶é—´ï¼Œè‡ªåŠ¨å°†çŠ¶æ€æ”¹ä¸ºå·²å®Œæˆï¼Œè¿›åº¦è®¾ä¸º100%
      if (task.status !== 'completed') {
        task.status = 'completed'
        task.progress = 100
      }
      await updateTaskInProject(task)
      ElMessage.success('å®é™…ç»“æŸæ—¶é—´å·²æ›´æ–°')
    }
  } catch (error) {
    // ç”¨æˆ·å–æ¶ˆæ“ä½œ
  }
}

// ä»»åŠ¡æ›´æ–°æ–¹æ³•
const updateTask = async () => {
  if (selectedTask.value) {
    await updateTaskInProject(selectedTask.value)
  }
}

// å¿«æ·æ“ä½œæ–¹æ³•
const setActualStartToday = async () => {
  if (selectedTask.value) {
    selectedTask.value.actualStartDate = DateUtils.format(new Date(), 'YYYY-MM-DD')
    if (selectedTask.value.status === 'not_started') {
      selectedTask.value.status = 'in_progress'
    }
    await updateTaskInProject(selectedTask.value)
    ElMessage.success('å·²è®¾ç½®ä»Šå¤©ä¸ºå®é™…å¼€å§‹æ—¶é—´')
  }
}

const setActualEndToday = async () => {
  if (selectedTask.value) {
    selectedTask.value.actualEndDate = DateUtils.format(new Date(), 'YYYY-MM-DD')
    selectedTask.value.status = 'completed'
    selectedTask.value.progress = 100
    await updateTaskInProject(selectedTask.value)
    ElMessage.success('å·²è®¾ç½®ä»Šå¤©ä¸ºå®é™…ç»“æŸæ—¶é—´')
  }
}

const resetActualTimes = async () => {
  if (selectedTask.value) {
    try {
      await ElMessageBox.confirm(
        'ç¡®å®šè¦é‡ç½®å®é™…æ—¶é—´å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å®é™…æ—¶é—´è®°å½•ã€‚',
        'ç¡®è®¤é‡ç½®',
        {
          confirmButtonText: 'ç¡®å®š',
          cancelButtonText: 'å–æ¶ˆ',
          type: 'warning',
        }
      )
      
      selectedTask.value.actualStartDate = null
      selectedTask.value.actualEndDate = null
      selectedTask.value.status = 'not_started'
      selectedTask.value.progress = 0
      await updateTaskInProject(selectedTask.value)
      ElMessage.success('å®é™…æ—¶é—´å·²é‡ç½®')
    } catch (error) {
      // ç”¨æˆ·å–æ¶ˆæ“ä½œ
    }
  }
}

// å·¥å…·æ–¹æ³•
const updateTaskInProject = async (updatedTask) => {
  try {
    // æ›´æ–°é¡¹ç›®ä¸­çš„ä»»åŠ¡
    const taskIndex = project.value.tasks.findIndex(t => t.id === updatedTask.id)
    if (taskIndex > -1) {
      project.value.tasks[taskIndex] = { ...updatedTask }
      
      // åŒæ­¥æ›´æ–°é€‰ä¸­çš„ä»»åŠ¡
      if (selectedTask.value && selectedTask.value.id === updatedTask.id) {
        selectedTask.value = { ...updatedTask }
      }
      
      // ä¿å­˜åˆ°æ•°æ®æœåŠ¡
      await projectDataService.update(projectId.value, project.value)
      
      // é‡æ–°è®¡ç®—é¡¹ç›®çŠ¶æ€ï¼ˆå…³é”®ä¿®å¤ï¼‰
      await projectDataService.updateProjectStatusBasedOnTasks(projectId.value)
      
      // é‡æ–°åŠ è½½é¡¹ç›®æ•°æ®ä»¥è·å–æœ€æ–°çŠ¶æ€
      await loadProject()
    }
  } catch (error) {
    console.error('Failed to update task:', error)
    ElMessage.error('æ›´æ–°ä»»åŠ¡å¤±è´¥')
  }
}

const isOverdue = (task) => {
  if (!task.endDate) return false
  
  const endDate = new Date(task.endDate)
  const today = new Date()
  const actualEndDate = task.actualEndDate ? new Date(task.actualEndDate) : today
  
  // å¦‚æœå·²å®Œæˆï¼Œæ£€æŸ¥æ˜¯å¦è¶…è¿‡è®¡åˆ’ç»“æŸæ—¶é—´
  if (task.status === 'completed') {
    return actualEndDate > endDate
  }
  
  // å¦‚æœæœªå®Œæˆï¼Œæ£€æŸ¥æ˜¯å¦å·²è¶…è¿‡è®¡åˆ’ç»“æŸæ—¶é—´
  return today > endDate && task.status !== 'completed'
}

const formatDate = (dateString) => {
  if (!dateString) return '-'
  return DateUtils.format(dateString, 'MM-DD')
}

// ç¼–è¾‘é¡¹ç›®å¯¹è¯æ¡†æ–¹æ³•
const handleCloseEditDialog = (done) => {
  ElMessageBox.confirm('ç¡®å®šè¦å…³é—­å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')
    .then(() => {
      editingProject.value = {}
      done()
    })
    .catch(() => {
      // å–æ¶ˆå…³é—­
    })
}

const cancelEditProject = () => {
  editingProject.value = {}
  showEditDialog.value = false
}

const saveProject = async () => {
  saving.value = true
  try {
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!editingProject.value.name?.trim()) {
      ElMessage.error('é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º')
      return
    }
    
    if (!editingProject.value.startDate || !editingProject.value.endDate) {
      ElMessage.error('è¯·é€‰æ‹©é¡¹ç›®çš„è®¡åˆ’å¼€å§‹å’Œç»“æŸæ—¶é—´')
      return
    }
    
    // ä¿å­˜é¡¹ç›®åŸºæœ¬ä¿¡æ¯å’Œä»»åŠ¡æ•°æ®
    await projectDataService.update(projectId.value, editingProject.value)
    
    // é‡æ–°è®¡ç®—é¡¹ç›®çŠ¶æ€ï¼ˆå…³é”®ï¼šç¡®ä¿çŠ¶æ€æ­£ç¡®æ›´æ–°ï¼‰
    await projectDataService.updateProjectStatusBasedOnTasks(projectId.value)
    
    // é‡æ–°åŠ è½½é¡¹ç›®æ•°æ®
    await loadProject()
    
    showEditDialog.value = false
    editingProject.value = {}
    ElMessage.success('é¡¹ç›®ä¿å­˜æˆåŠŸ')
  } catch (error) {
    console.error('Failed to save project:', error)
    ElMessage.error('ä¿å­˜é¡¹ç›®å¤±è´¥')
  } finally {
    saving.value = false
  }
}

// ä»»åŠ¡å®é™…æ—¶é—´å¤„ç†æ–¹æ³•
const handleActualTimeChange = async (task, type) => {
  try {
    // è‡ªåŠ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€
    if (type === 'start' && task.actualStartDate) {
      if (task.status === 'not_started') {
        task.status = 'in_progress'
      }
    } else if (type === 'end' && task.actualEndDate) {
      if (task.actualStartDate) {
        task.status = 'completed'
        task.progress = 100
      }
    }
    
    // éªŒè¯æ—¶é—´é€»è¾‘
    if (task.actualStartDate && task.actualEndDate) {
      const startTime = new Date(task.actualStartDate)
      const endTime = new Date(task.actualEndDate)
      
      if (endTime < startTime) {
        ElMessage.warning('å®é™…ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºå®é™…å¼€å§‹æ—¶é—´')
        if (type === 'end') {
          task.actualEndDate = null
        }
        return
      }
    }
    
    ElMessage.success(`å®é™…${type === 'start' ? 'å¼€å§‹' : 'ç»“æŸ'}æ—¶é—´å·²æ›´æ–°`)
  } catch (error) {
    console.error('Failed to update actual time:', error)
    ElMessage.error('æ›´æ–°æ—¶é—´å¤±è´¥')
  }
}

const setTaskActualStartToday = (task) => {
  task.actualStartDate = new Date()
  handleActualTimeChange(task, 'start')
}

const setTaskActualEndToday = (task) => {
  if (!task.actualStartDate) {
    ElMessage.warning('è¯·å…ˆè®¾ç½®å®é™…å¼€å§‹æ—¶é—´')
    return
  }
  task.actualEndDate = new Date()
  handleActualTimeChange(task, 'end')
}

// å¤‡æ³¨å¤„ç†æ–¹æ³•
const handleNotesChange = (task) => {
  // å¤‡æ³¨å˜æ›´æ—¶çš„å¤„ç†é€»è¾‘ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
  console.log(`Task ${task.name} notes updated:`, task.notes)
}

const setNoteTemplate = (task, template) => {
  if (task.notes && task.notes.trim()) {
    // å¦‚æœå·²æœ‰å¤‡æ³¨ï¼Œè¯¢é—®æ˜¯å¦æ›¿æ¢
    ElMessageBox.confirm(
      'å½“å‰ä»»åŠ¡å·²æœ‰å¤‡æ³¨ï¼Œæ˜¯å¦è¦æ›¿æ¢ä¸ºæ¨¡æ¿å†…å®¹ï¼Ÿ',
      'ç¡®è®¤æ›¿æ¢',
      {
        confirmButtonText: 'æ›¿æ¢',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning',
      }
    ).then(() => {
      task.notes = template
    }).catch(() => {
      // ç”¨æˆ·å–æ¶ˆ
    })
  } else {
    task.notes = template
  }
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  loadProject()
})

// ç›‘å¬è·¯ç”±å˜åŒ–
watch(() => route.params.id, () => {
  loadProject()
})
</script>

<style lang="scss" scoped>
.gantt-chart {
  padding: 24px;
  background: var(--color-bg-light);
  min-height: 100vh;

  &__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--el-border-color-light);
  }

  &__title-section {
    display: flex;
    align-items: flex-start;
    gap: 16px;
  }

  &__back-btn {
    margin-top: 4px;
  }

  &__title-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  &__title {
    font-size: 28px;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
  }

  &__subtitle {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: var(--color-text-secondary);
  }

  &__actions {
    display: flex;
    gap: 12px;
  }

  &__overview {
    margin-bottom: 24px;
  }

  .overview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .overview-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

    &__icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--el-color-primary-light-9);
      color: var(--el-color-primary);
      border-radius: 8px;
      font-size: 20px;
    }

    &__content {
      flex: 1;
    }

    &__value {
      font-size: 24px;
      font-weight: 600;
      color: var(--color-text-primary);
      line-height: 1;
    }

    &__label {
      font-size: 14px;
      color: var(--color-text-secondary);
      margin-top: 4px;
    }
  }

  .overview-progress {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

    &__label {
      font-size: 14px;
      color: var(--color-text-secondary);
      margin-bottom: 12px;
    }
  }

  &__content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  &__toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--el-border-color-light);
  }

  &__main {
    display: flex;
    height: 700px;
  }

  .task-table-container {
    flex: 1;
    transition: all 0.3s ease;
    
    &.with-detail-panel {
      flex: 0 0 70%;
    }
  }

  .empty-state {
    padding: 40px;
    text-align: center;
  }

  // è¡¨æ ¼æ ·å¼
  .task-name-cell {
    display: flex;
    align-items: center;
    gap: 8px;
    
    .milestone-icon {
      color: var(--el-color-warning);
      font-size: 16px;
    }
  }

  .time-cell {
    position: relative;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    
    &.planned {
      background: var(--el-color-primary-light-9);
      color: var(--el-color-primary);
      border: 1px solid var(--el-color-primary-light-7);
    }
    
    &.actual {
      background: var(--el-color-success-light-9);
      color: var(--el-color-success);
      border: 1px solid var(--el-color-success-light-7);
      
      &.editable {
        cursor: pointer;
        transition: all 0.2s;
        
        .edit-icon {
          opacity: 0;
          margin-left: 4px;
          font-size: 10px;
          transition: opacity 0.2s;
        }
        
        &:hover {
          background: var(--el-color-success-light-8);
          
          .edit-icon {
            opacity: 1;
          }
        }
        
        .placeholder {
          color: var(--el-color-info);
          font-style: italic;
        }
        
        &.has-value {
          font-weight: 500;
        }
        
        &.overdue {
          background: var(--el-color-danger-light-9);
          color: var(--el-color-danger);
          border-color: var(--el-color-danger-light-7);
        }
      }
    }
  }

  .progress-cell {
    display: flex;
    align-items: center;
    gap: 8px;
    
    .progress-text {
      font-size: 12px;
      color: var(--color-text-secondary);
      min-width: 35px;
    }
  }

  .action-buttons {
    display: flex;
    gap: 4px;
  }

  // è¡¨æ ¼è¡Œæ ·å¼
  :deep(.el-table) {
    .selected-row {
      background-color: var(--el-color-primary-light-9) !important;
    }
    
    .overdue-row {
      background-color: var(--el-color-danger-light-9) !important;
    }
    
    .milestone-row {
      background-color: var(--el-color-warning-light-9) !important;
    }
    
    .status-overdue {
      animation: pulse 2s infinite;
    }
  }

  // è¡¨æ ¼å¤´éƒ¨æ ·å¼
  .planned-header {
    color: var(--el-color-primary);
    font-weight: 600;
  }
  
  .actual-header {
    color: var(--el-color-success);
    font-weight: 600;
  }

  // ä»»åŠ¡è¯¦æƒ…é¢æ¿
  .task-detail-panel {
    flex: 0 0 30%;
    border-left: 1px solid var(--el-border-color-light);
    background: var(--el-fill-color-extra-light);
    display: flex;
    flex-direction: column;
  }

  .detail-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--el-border-color-light);
    background: white;
    
    h3 {
      margin: 0;
      font-size: 16px;
      color: var(--color-text-primary);
    }
  }

  .detail-panel-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }

  .detail-section {
    margin-bottom: 24px;
    
    h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: var(--color-text-primary);
      font-weight: 600;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--el-border-color-lighter);
    }
  }

  .detail-form {
    background: white;
    padding: 16px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .quick-actions {
    background: white;
    padding: 16px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  // å“åº”å¼è®¾è®¡
  @media (max-width: 1200px) {
    .gantt-chart__main {
      flex-direction: column;
      height: auto;
    }
    
    .task-table-container {
      flex: none !important;
      margin-bottom: 20px;
    }
    
    .task-detail-panel {
      flex: none;
      border-left: none;
      border-top: 1px solid var(--el-border-color-light);
      max-height: 500px;
    }
  }

  @media (max-width: 768px) {
    padding: 16px;

    &__header {
      flex-direction: column;
      gap: 16px;
      align-items: stretch;
    }

    &__title-section {
      flex-direction: column;
      gap: 12px;
    }

    &__actions {
      justify-content: center;
    }

    &__toolbar {
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
    }

    .overview-cards {
      grid-template-columns: 1fr;
    }
    
    .detail-panel-content {
      padding: 15px;
    }
    
    .quick-actions {
      flex-direction: column;
      
      .el-button {
        width: 100%;
      }
    }
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

// ç¼–è¾‘é¡¹ç›®å¯¹è¯æ¡†æ ·å¼
.project-edit-dialog {
  .edit-section {
    margin-bottom: 32px;
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      color: var(--el-text-color-primary);
      margin-bottom: 20px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--el-color-primary);
      
      .el-icon {
        color: var(--el-color-primary);
      }
    }
    
    .status-note {
      font-size: 12px;
      color: var(--el-text-color-secondary);
      margin-left: 8px;
    }
  }
  
  .tasks-edit-area {
    max-height: 400px;
    overflow-y: auto;
    
    .task-edit-item {
      background: var(--el-bg-color-page);
      border: 1px solid var(--el-border-color-light);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      
      &:hover {
        border-color: var(--el-color-primary);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        
        .task-info {
          display: flex;
          align-items: center;
          gap: 12px;
          
          .task-name {
            font-weight: 600;
            color: var(--el-text-color-primary);
            font-size: 14px;
          }
          
          .milestone-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--el-color-warning);
            font-size: 12px;
            
            .el-icon {
              font-size: 14px;
            }
          }
        }
        
        .task-assignee {
          font-size: 12px;
          color: var(--el-text-color-secondary);
        }
      }
      
      .task-times {
        margin-bottom: 16px;
        
        .time-item {
          label {
            display: block;
            font-size: 12px;
            color: var(--el-text-color-secondary);
            margin-bottom: 4px;
          }
          
          .time-value {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            
            &.planned {
              background: var(--el-color-info-light-9);
              color: var(--el-color-info);
              border: 1px solid var(--el-color-info-light-7);
            }
          }
          
          .quick-actions {
            margin-top: 4px;
            
            .el-button {
              padding: 2px 6px;
              font-size: 11px;
              height: auto;
            }
          }
        }
      }
      
      .task-notes {
        .notes-templates {
          margin-top: 8px;
          display: flex;
          align-items: center;
          gap: 8px;
          flex-wrap: wrap;
          
          .template-label {
            font-size: 12px;
            color: var(--el-text-color-secondary);
          }
          
          .el-button {
            padding: 2px 8px;
            font-size: 11px;
            height: auto;
          }
        }
      }
    }
  }
  
  .no-tasks {
    text-align: center;
    padding: 40px 20px;
    background: var(--el-bg-color-page);
    border-radius: 8px;
    border: 2px dashed var(--el-border-color-light);
  }
  
  .dialog-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
}

// å“åº”å¼è®¾è®¡
@media (max-width: 768px) {
  .project-edit-dialog {
    .task-times {
      .el-row {
        .el-col {
          margin-bottom: 16px;
        }
      }
    }
    
    .notes-templates {
      flex-direction: column;
      align-items: flex-start;
      
      .el-button {
        width: 100%;
        justify-content: flex-start;
      }
    }
  }
}

// å¤‡æ³¨åˆ—æ ·å¼
.notes-cell {
  .notes-content {
    color: #606266;
    font-size: 13px;
    line-height: 1.4;
    cursor: help;
    
    &:hover {
      color: #409eff;
    }
  }
  
  .notes-placeholder {
    color: #c0c4cc;
    font-size: 12px;
    font-style: italic;
  }
}

// å•ä»»åŠ¡ç¼–è¾‘å¯¹è¯æ¡†æ ·å¼
.task-edit-dialog {
  .el-form {
    .el-form-item {
      margin-bottom: 18px;
    }
  }
  
  .notes-templates {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    
    .template-label {
      font-size: 12px;
      color: #909399;
      margin-right: 4px;
    }
    
    .el-button {
      font-size: 12px;
      padding: 4px 8px;
      height: auto;
      
      &:hover {
        background-color: #ecf5ff;
        color: #409eff;
      }
    }
  }
  
  .quick-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    
    .el-button {
      flex: 1;
      min-width: 100px;
    }
  }
}

// è¡¨æ ¼è¡Œæ ·å¼å¢å¼º
.el-table {
  .notes-cell {
    padding: 8px 12px;
  }
}
</style>